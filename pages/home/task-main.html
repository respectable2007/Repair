<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no" />
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>维修列表和详情</title>
		<link rel="stylesheet" href="../../css/mui.min.css" />
		<link rel="stylesheet" type="text/css" href="../../css/iconfont.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/mui.picker.min.css"/>
		<style type="text/css">
		  aside .mui-content .mui-scroll-wrapper{
		    top: 70px;
		  }
		  .mui-bar{
		  	height: 46px;
		  }
		  .mui-bar .mui-segmented-control{
		  	top:0;
		  }
		  .mui-inner-wrap .mui-content{
		  	padding-top: 46px;
		  }
		  .mui-table-view{
		  	background: transparent;
		  }
		  .mui-card{
		    box-shadow: 0 0 2px rgba(0,0,0,0.4);
		  }
		  .bages .mui-badge{
		  	padding: 6px 9px;
		  }
		  .triangle-topright{
		  	width: 0;
		  	height: 0;
		  	border-top:40px solid red;
		  	border-left:40px solid transparent;
		  	margin-top: -10px;
            margin-right: -14px;
		  }
		  .triangle-topright:after{
		  	content: '待抢单';
		    font-size: 1px;
		    position: absolute;
		    top: 6px;
		    transform: rotate(45deg);
		    right: 0;
		    color: #fff;
		  }
		</style>
	</head>
	<body>
	  <div id='app' class="mui-off-canvas-wrap mui-slide-in">
	  	<aside class="mui-off-canvas-right"
	  		   id='searchArea'>
	  	  <div class="mui-content">
	  	  	<div class="mui-input-row">
	  	  	  <input type="search" 
	  	  	  	     class="mui-input-clear"
	  	  	  	     placeholder="请输入关键字"
	  	  	  	     v-model="search"
	  	  	  	     @keyup="handleSearch($event)"/>
	  	  	</div>
	  	  	<div class="mui-scroll-wrapper">
	  	  	  <div class="mui-scroll">
	  	  	  	<div v-show='search.length'>
	  	  	  	  <ul class="mui-table-view">
	  	  	  	  	<li v-for='(item) in searchList'
	  	  	  	  		class="mui-table-view-cell"
	  	  	  	  		@tap='handleSelected(item)'>
	  	  	  	  	  {{item.TITLE}}
	  	  	  	  	</li>
	  	  	  	  </ul>
	  	  	  	</div>
	  	  	  	<div v-show='!search.length'>
	  	  	  	  <ul class="mui-table-view">
	  	  	  	  	<li class="mui-table-view-cell mui-active mui-collapse">
	  	  	  	  	   <a href="javascript:void(0)"
	  	  	  	  	   	  class="mui-navigate-right">
	  	  	  	  	       历史记录
	  	  	  	  	   </a>
	  	  	  	  	   <div class="mui-collapse-content">
	  	  	  	  	     <div class="mui-input-group"
	  	  	  	  	       	  v-if='historyList.length'>
	  	  	  	  	       <div class="mui-input-row"
	  	  	  	  	       	    v-for='(item) in historyList'
	  	  	  	  	       	    @tap = 'handleSelectedHistory(item)'>
	  	  	  	  	       	  {{item.name}}
	  	  	  	  	       </div>
	  	  	  	  	     </div>
  	  	  	  	         <div class="mui-input-group"
  	  	  	  	       	    v-else>
  	  	  	  	       	   暂无历史记录
  	  	  	  	         </div>
	  	  	  	  	   </div>
	  	  	  	  	   <span @tap='handleClearHistory()'>
	  	  	  	  	   	<i class="mui-icon mui-icon-trash i-clear"></i>
	  	  	  	  	   </span>
	  	  	  	  	</li>
	  	  	  	  </ul>
	  	  	  	</div>
	  	  	  </div>
	  	  	</div>
	  	  </div>
	  	  <a href="#searchArea"
	  	  	@tap='handleCloseCanvas()'>取消</a>
	  	</aside>
	  	<div class="mui-inner-wrap">
	  		<header class="mui-bar mui-bar-nav">
		  	  <form class="mui-segmented-control">
		  	  	<a class="mui-control-item">
		  	  		<span v-text='address'
		  	  			  @tap='handleShowPro()'></span>
		  	  		<i class="mui-icon mui-icon-arrowdown"></i>
		  	  	</a>
		  	  	<a class="mui-control-item" 
		  	  	   @tap='handleShowArea()'
		  	  	   href="#searchArea">
		  	  		<span v-text='buildName'></span>
		  	  		<i class="mui-icon mui-icon-arrowdown"></i>
		  	  	</a>
		  	  	<a class="mui-control-item"
		  	  		@tap='handleSatus()'>
		  	  		<span >工单状态</span>
		  	  		<i class="mui-icon mui-icon-arrowdown"></i>
		  	  	</a>
		  	  </form>
		  	</header>
		  	<div class="mui-content mui-scroll-wrapper" id='pullRefresh'>
		  	  <div class="mui-scroll">
		  	  	<ul class="mui-table-view" v-if='list.length'>
		  	  	  <li class="mui-table-view-cell"
		  	  	  	  v-for='item in list'>
		  	  	    <div class="mui-card">
		  	  	      <div class="mui-card-header"
		  	  	           @tap='handleOpenDetail(item)'>
		  	  	      	工单号:{{item.orderNumber}}
		  	  	      	<div class="triangle-topright" v-if='item.status'></div>
		  	  	      </div>
		  	  	      <div class="mui-card-content">
		  	  	      	<div class="mui-card-content-inner">
		  	  	      	  <div class="bages">
		  	  	      	  	<span class="mui-badge mui-badge-green">奖励￥2{{item.money}}</span>
		  	  	      	  	<span class="mui-badge mui-badge-blue">{{item.hour}}1小时完成</span>
		  	  	      	  	<span class="mui-badge mui-badge-danger" v-show='item.IS_URGENCY'>紧急</span>
		  	  	      	  </div>
		  	  	      	  <div class="middle">
		  	  	      	  	<p>{{item.title}}</p>
		  	  	      	  	<p>{{item.msg}}</p>
		  	  	      	  </div>
		  	  	      	</div>
		  	  	      </div>
		  	  	      <div class="mui-card-footer">
		  	  	      	{{item.datetime}}
		  	  	      	<button class="mui-btn mui-btn-outlined">派工</button>
		  	  	      	<button class="mui-btn mui-btn-danger">立即抢单</button>
		  	  	      	<!--<button class="mui-btn mui-btn-outlined">转单</button>
		  	  	      	<button class="mui-btn mui-btn-outlined">签到</button>
		  	  	      	<button class="mui-btn mui-btn-outlined">完工</button>
		  	  	      	<button class="mui-btn mui-btn-outlined">评价</button>-->
		  	  	      </div>
		  	  	    </div>
		  	  	  </li>
		  	  	</ul>
		  	  	<div class="empty-container" v-else>
		  	  		<div class="nodata-info">
		  	  		   暂无工单信息
		  	  		</div> 
		  	  	</div>
		  	  </div>
		  	</div>
	  	</div>	  	
	  </div>
	  <script src="../../js/mui.min.js" type="text/javascript"></script>
	  <script src="../../js/libs/mui.picker.min.js" type  ="text/javascript"></script>
	  <script src="../../js/libs/vue.min.js" type="text/javascript"></script>
	  <script src="../../js/common/config.js" type  ="text/javascript"></script>
	  <script src="../../js/libs/mock-min.js" type  ="text/javascript"></script>
	  <script src="../../js/common/global.js" type  ="text/javascript"></script>
	  <script src="../../js/common/webSql.js" type  ="text/javascript"></script>
	  <script src="../../js/common/mockdata.js" type  ="text/javascript"></script>
	  <script src="../../js/common/web-storage-cache.js" type  ="text/javascript"></script>
	  <script src="../../js/common/json.js" type  ="text/javascript"></script>
	  <script type="text/javascript">
	  	var dvAll = [],
	  	    key = 'BuildHistoryList',
	  	    ws = new WebStorageCache(),
	  	    findList = [],
	  	    pageNum = 0,
	  	    pageSize = 10,
	  	    all = [],
	  	    refresh = 0,
	  	    app = new Vue({
	  	      el: '#app',
	  	      data: {
	  	      	search: '',
	  	      	searchList: [],
	  	      	historyList: [],
	  	      	buildName: '建筑名称',
	  	      	address: '行政区域',
	  	      	districtList: [],
	  	      	typeid: '',
	  	        w_repair: {
  	              orgCode: config.ORG_CODE,
				  userId: config.USER_ID,
				  state: null,
				  deptCode: null,
				  districtId: null,
				  buildId: '',
				  //reportTime_BT: g.operationDate(-365),
				  //reportTime_ET: g.operationDate(+1),
				  start: 0,
				  pageSize: pageSize
	  	        },
	  	        list: [{
	  	          orderNumber: 'afb1bc58-d829-89e3',
	  	          IS_URGENCY: true,
	  	          title: 'xx小区6栋1705号',
	  	          msg: '锁坏了',
	  	          datetime:'2018-11-25 13:05:35',
	  	          status: true
	  	        }]
	  	      },
	  	      mounted: function() {
	  	      	var self = this;
//	  	      	mui.init({
//	  	      	  pullRefresh: {
//	  	      	    container: '#pullRefresh',
//		  	      	down: {
//		  	      	  style: 'circle',
//		  	      	  callback: self.down
//		  	      	},
//		  	      	up: {
//		  	      	  auto: true,
//		  	      	  contentrefresh: '正在加载',
//		  	      	  callback: self.up
//		  	      	}
//	  	      	  }
//	  	      	})
	  	      	mui.ready(function() {
	  	      	  getAllList();
	  	      	})
	  	      	mui.plusReady(function(){
	  	      	  var vm = plus.webview.currentWebview();
	  	      	  self.typeid = vm.typeid;
	  	      	})
	  	      },
	  	      methods: {
	  	      	handleShowArea: function(){
	  	      	  getHistoryList();
	  	      	},
	  	      	handleCloseCanvas: function(){
	  	      	   this.search = '';
	  	      	   
	  	      	},
	  	      	handleSearch: function(e) {
	  	      	  var key =  e.target.value
	  	      	  this.search = key;
	  	      	  getSearchList(key);
	  	      	},
	  	      	handleSelected: function(item){
	  	      	  addHistory(key, item);
	  	      	  this.search = '';
	  	      	  this.goBack();
	  	      	  this.buildName = item.TITLE;
	  	      	  this.w_repair.buildId = item.ID;
	  	      	},
	  	      	handleSelectedHistory: function(item){
	  	      	  this.goBack();
	  	      	  this.buildName = item.name;
	  	      	  this.w_repair.buildId = item.id;
	  	      	},
	  	      	handleClearHistory: function(){
	  	      	  var that = this;
	  	      	  mui.confirm('确认清空历史记录吗？', '确认', ['取消','确认'],function(e){
	  	      	  	if(e.index == 1){
	  	      	  	  ws.delete(key);
	  	      	  	  that.historyList = [];
	  	      	  	}
	  	      	  })
	  	      	},
	  	      	goBack: function(){
	  	      	  mui('#searchArea').offCanvas('close');
	  	      	},
	  	      	handleShowPro: function() {
	  	      	  var pPicker = new mui.PopPicker({
	  	      	  	layer: 3
	  	      	  }),
	  	      	  that = this;
	  	      	  if(that.districtList.length > 0) {
	  	      	    return;
	  	      	  }
	  	      	  g.ajax(config.QueryAllDistrictTree, {
	  	      	  	success: function(data) {
	  	      	  	  if(data.StatusCode == 200) {
	  	      	  	  	if(data.Data.length > 0) {
	  	      	  	  	  pPicker.setData([{"value":'000000',"text":'全国',"children":[]}].concat(data.Data));
	  	      	  	  	  pPicker.pickers[0].setSelectedIndex(1);
						  pPicker.pickers[1].setSelectedIndex(1);
						  pPicker.show(function(item) {
                            var i = null;
                            if(item[2].value) {
                              i = item[2];
                            } else if(item[1].value){
                              i = item[1];
                            } else if(item[0].value) {
                              i = item[0];
                            }
                            that.districtId = i.value;
                            if(!i) {
                              that.address = '行政区域';
                            }
                            that.address = i.text === '全区' ? item[1].text : i.text;
						  })
	  	      	  	  	}
	  	      	  	  }
	  	      	  	}
	  	      	  })
	  	      	},
	  	      	handleSatus: function(){
	  	      	  var typeid = this.typeid,
	  	      	      picker = g.getOrderStatusPicker(typeid, typeid === 'repair' ? 'manage': undefined),
	  	      	      that = this;
	  	      	  picker.show(function(item) {
	  	      	  	that.w_repair.stat = item[0].value;
	  	      	  })
	  	      	},
	  	      	//下拉刷新
	  	      	down: function(){
//	  	      	  console.log(1);
	  	      	  refresh = 0;
	  	      	  setTimeout(function(){
	  	      	  	mui('#pullRefresh').pullRefresh().endPulldownToRefresh(true);
	  	      	  	console.log(1);
	  	      	  }, 1500);
	  	      	},
	  	      	//上拉加载
	  	      	up: function(){
	  	      	  var that = this;
	  	      	  refresh = 1;
	  	      	  setTimeout(function(){
	  	      	  	mui('#pullRefresh').pullRefresh().endPullupToRefresh();
	  	      	  	that.w_repair.start = ++ pageNum ;
	  	      	  	getList();
	  	      	  },1500)
	  	      	},
	  	      	handleOpenDetail:function(item){
	  	      	  console.log(1);
	  	      	}
	  	      }
	  	    });
	   //获取工单列表
	   function getList(){
	   	if(config.isMock) {
	   	  var _where = 'where 1=1';
	   	  if(app.w_repair.buildId) {
	   	    _where += ' and BUILD_ID="'+ app.w_repair.buildId +'"';
	   	  }
	   	  if(app.w_repair.districtId) {
	   	    _where += ' and DIST_ID="'+ app.w_repair.districtId +'"'; 
	   	  }
	   	  if(app.w_repair.state) {
            _where += ' and STATE="'+ app.w_repair.state +'"';	   	  	
	   	  }
	   	  _where += ' ORDER BY REPORT_TIME DESC limit ' + pageSize + ' offset ' + (pageNum - 1) * pageSize;
	   	  _database.read(smp_tb.repair_tb, _where, function(res) {
	   	  	var data = {
	   	  	  "StatusCode": 200,
	   	  	  "Message": null,
	   	  	  "Data": {
	   	  	  	"lstData": res,
	   	  	  	"recc": res.length
	   	  	  },
	   	  	 }
	   	  	  dv = [];
	   	  	  if(res != null) {
	   	  	  	for(var i = 0, lens = res.length; i < lens; i++) {
	   	  	  	  var d = {
	   	  	  	  	ACCEPT_USER_ID: res[i].ACCEPT_USER_ID,
                    CREATE_USER_ID: res[i].CREATE_USER_ID, 
                    orderNumber: res[i].NO,
                    status: res[i].STATE,
                    money: res[i].MONEY,
                    hour: res[i].HOURS,
                    IsOverTime: res[i].IsOverTime,
                    title: res[i].BUILD_NAME, 
                    msg: res[i].FAULT_INFO,
                    datetime: g.formatDate(res[i].REPORT_TIME, 'YMDHMS'),
                    PRESS_NUM: res[i].PRESS_NUM, //催单次数
                    IS_URGENCY: res[i].IS_URGENCY,
                    IS_WAITING: res[i].IS_WAITING//这里添加是否待料
	   	  	  	  };
	   	  	  	  dv.push(d);
	   	  	  	  all.push(d);
	   	  	  	}
	   	  	  }
	   	  	  if(!refresh) {
	   	  	    app.list = dv;
	   	  	  }else{
	   	  	  	app.list = all;
	   	  	  }

	   	  })
	   	}
	   }
	   //获取建筑名称全列表
	   function getAllList(){
	        var nwaiting = window.plus === undefined ? null : plus.nativeUI.showWaiting();
		  	g.ajax(config.GetBuildsPage,{
		  	  data: {start:0, end: 1000, lstOrgCode: config.ORG_CODE, buildName: app.search},
		  	  nwaiting: nwaiting,
		  	  success: function(data){
		  	  	var dv = [];
		  	  	if(data.StatusCode === 200) {
		  	  	  for(var i = 0, len = data.Data.List.length; i < len; i++){
		  	  	  	var d = {
		  	  	  	  ID: data.Data.List[i].BUILD_ID,
		  	  	  	  TITLE:data.Data.List[i].BUILD_NAME,
		  	  	  	  ADDRESS:data.Data.List[i].ADDRESS
		  	  	  	}
		  	  	  	dv.push(d);
		  	  	  	dvAll.push(d);
		  	  	  }
		  	  	}
		  	  	app.searchList = dvAll;
		  	  	if(window.plus != undefined) {
		  	  	  plus.nativeUI.closeWaiting();
		  	  	}
		  	  },
		  	  error: function(){
		  	  	if(nwaiting){
		  	  	  nwaiting.close();
		  	  	}
		  	  }
		  	})
	   }
	   //增加搜索记录
	   function addHistory(key, item) {
	   	  var cookie = ws.get(key),
	   	      str = (cookie == null || cookie == '') ? '{"'+ key +'":[]}' : cookie,
	   	      json = new S_JSON(str);
	   	  json[key].push('{"name":"'+ item.TITLE+ '", "id":"'+ item.ID + '","address":"'+item.ADDRESS+'"}');
	   	  ws.set(key,json.toString(),{
	   	  	exp: 30 * 24 * 3600
	   	  }); 
	   }
	   //获取搜索列表
	   function getSearchList(key) {
	   	findList = [];
	   	var lens = dvAll.length;
	   	if(lens > 0) {
	   	  for(var i = 0; i < lens; i++) {
	   	    var item = dvAll[i]; 
	   	  	if(item.TITLE.indexOf(key) > -1) {
	   	  	  findList.push(item);
	   	  	}
	   	  }
	   	  app.searchList = findList;
	   	}
	   }
	   function getHistoryList(){
	     var _list = [],
	        cookie = ws.get(key);
	    app.historyList = _list;
	    if(cookie == null || cookie == '') {
	      return;
	    }
	    var json = new S_JSON(cookie);
	    if(json[key] == null || json[key] == undefined) {
	      return;
	    }
	    var lens = json[key].length,
	        i = 0,
	        item = null
	        m = 5;
	    if(lens > 0) {
	      for(i; i < lens; i++) {
	      	item = json[key][i];
	      	if(!isExitList(_list, item.name) && m > 0) {
	      	  _list.push(item);
	      	  m --;
	      	}
	      }
	      app.historyList = _list;
	    }
	   }
	   //去重
	   function isExitList(list, name) {
	   	var i = 0,
	   	    lens = list.length,
	   	    item = null;
	   	for(i; i < lens; i++) {
	   	  item = list[i];
	   	  if(item.name == name) {
	   	  	return true;
	   	  }
	   	}
	   	return false;
	   }
	  </script>
	</body>
</html>
