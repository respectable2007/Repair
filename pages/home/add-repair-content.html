<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name='viewport' content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
		<title></title>
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<style type="text/css">
		  aside .mui-content .mui-scroll-wrapper{
		    top: 70px;
		  }
		</style>
	</head>
	<body>
	  <div id="app" class="mui-off-canvas-wrap mui-slide-in">
	  	<!--菜单部分-->
	  	<aside class="mui-off-canvas-right" id='searchArea'>
	  	  <div class="mui-content">
	  	  	<div class="mui-input-row">
	  	  	  <input type="search" 
	  	  	  	     placeholder="请输入关键字"
	  	  	  	     class="mui-input-clear"
	  	  	  	     id='search'
	  	  	  	     v-model="search"
	  	  	  	     @keyup="handleSearchList($event)"/>
	  	  	  <a href="#searchArea" @tap='handleClearSearch()'>取消</a>
	  	  	</div>
	  	  	<div class="mui-scroll-wrapper">
		  	  <div class="mui-scroll">
		  	    <div v-show='search'>
		  	      <ul class="mui-table-view">
		  	      	<li v-for='item in autoSearchList'
		  	      		@tap='handleSelected(item)'
		  	      		class="mui-table-view-cell">
		              {{item.TITLE}}
		  	      	</li>
		  	      </ul>
		  	    </div>
		  	    <div v-show='!search.length'>
		  	      <!--历史记录-->
		  	      <ul class="mui-table-view">
		  	      	<li class="mui-table-view-cell mui-collapse mui-active">
		  	      	  <a href="javascript:void(0);"
		  	      	  	 class="mui-navigate-right">
		  	      	      历史记录
		  	      	  </a>
		  	      	  <div class="mui-collapse-content">
		  	      	  	<div class="mui-input-group" v-if='historyList.length'>
		  	      	  	  <div class="mui-input-row"
		  	      	  	  	   v-for='item in historyList'
		  	      	  	  	   @tap='handleHistoryDetail(item)'>
		  	      	  	  	{{item.name}}
		  	      	  	  </div>
		  	      	  	</div>
		  	      	  	<div class="mui-input-group" v-else>
		  	      	  	   <div class="mui-input-row">
		  	      	  	   	  暂无历史记录
		  	      	  	   </div>
		  	      	  	</div>
		  	      	  </div>
		  	      	  <span class="" @tap='handleClearHistory()'>
		  	      	  	<i class="mui-icon mui-icon-trash i-clear"></i>
		  	      	  </span>
		  	      	</li>
		  	      </ul>
		  	    </div>
		  	  </div>
		  	</div>
	  	  </div>
	  	</aside>
	  	<!--主页表单部分-->
	  	<div class="mui-inner-wrap">
	  	  <nav class="mui-bar mui-bar-tab">
	  	  	<button id='btnSubmit' type="button" class="mui-btn mui-btn-primary mui-btn-block">
	  	  	  提交
	  	  	</button>
	  	  </nav>
	  	  <div class="mui-content" id='mui-content'>
	  	  	<form class="mui-input-group">
	  	  	  <div v-if='repairType == 1'>
	  	  	  	<div>
	  	  	  	  <span>建筑信息</span>
	  	  	  	</div>
	  	  	  	<div>
	  	  	  	  <div>建筑名称</div>
	  	  	  	  <div v-text='data_v.BUILD_NAME'></div>
	  	  	  	</div>
	  	  	  </div>
	  	  	  <div v-else>
	  	  	  	<div class="mui-input-row mui-search readonly">
	  	  	  	  <a href="#searchArea"
	  	  	  	  	 @tap='handleShowArea()'>
	  	  	  	  	 <i class="mui-icon mui-icon-search"></i>
	  	  	  	  	 <span v-text="data_v.BUILD_NAME"></span>
	  	  	  	  </a>
	  	  	  	</div>
	  	  	  	<div class="mui-input-row">
	  	  	  	  <label>
	  	  	  	  	<i class="require">*</i>
	  	  	  	  	建筑地址
	  	  	  	  </label>
	  	  	  	  <input type="text" v-model='data_v.ADDRESS' placeholder="建筑地址" class="mui-navigate-right"/>
	  	  	  	</div>
	  	  	  </div>
	  	  	</form>
	  	  </div>
	  	</div>
	  </div>
	  <script src="../../js/mui.min.js" type  ="text/javascript"></script>
	  <script src="../../js/libs/vue.min.js" type  ="text/javascript"></script>
	  <script src="../../js/common/config.js" type  ="text/javascript"></script>
	  <script src="../../js/libs/mock-min.js" type  ="text/javascript"></script>
	  <script src="../../js/common/global.js" type  ="text/javascript"></script>
	  <script src="../../js/common/mockdata.js" type  ="text/javascript"></script>
	  <script src="../../js/common/web-storage-cache.js" type  ="text/javascript"></script>
	  <script src="../../js/common/json.js" type  ="text/javascript"></script>
	  <script type="text/javascript">
	  	mui.init();
        var defaultTxt = "搜索建筑名称（必填）",
            //分页
            pageSize = 1000,
            pageIndex = 0,
            start = 0,
            end = pageSize,
            dvAll = [],
            findData = [],//查找后集合
            operatorType = 0,//操作类型：1：代表下拉刷新，2：上拉加载
            wsCache = new WebStorageCache(),
		    app = new Vue({
		      el: '#app',
		      data: {
		      	repairType:0,//文字报修
		      	data_v: {
		      	  BUILD_NAME: defaultTxt,
		      	  ADDRESS: '',
		      	  BUILD_ID: ''
		      	},
		      	search: '',
		      	autoSearchList: [],
		      	historyList: [],
		      	buildWhere: {
		      	  start:0,
		      	  end:10,
		      	  lstOrgCode: config.ORG_CODE,
		      	  buildName: ''//建筑查询
		      	}
		      },
		      mounted: function() {
		      	mui.ready(function(){
		      	  getListAll();
		      	  g.initScroll({
			      	id: 'mui-content',
			        h: g.getScreenInfo('width')
			      })
		      	})
		      },
		      methods: {
		      	//清空关键字
		      	handleClearSearch: function() {
		      	  this.search = '';
		      	  findData = [];
		      	},
		      	//获取搜索列表
		      	handleSearchList: function(e){
		      	  this.search = e.target.value;
		      	  getListByKey(e.target.value);
		      	},
		      	//选中搜索列表
		      	handleSelected: function(item) {
		      	  addHistory('BuildHistory', item);
		      	  this.search = '';
		      	  this.data_v.ADDRESS = item.ADDRESS;
		      	  this.data_v.BUILD_NAME = item.TITLE;
		      	  this.data_v.BUILD_ID = item.ID;
		      	  this.goBack();
		      	},
		      	//返回主页面
		      	goBack: function(){
		      	  mui('#searchArea').offCanvas('close');
		      	},
		      	//选中历史列表
		      	handleHistoryDetail: function(item) {
		      	  this.data_v.ADDRESS = item.address;
		      	  this.data_v.BUILD_NAME = item.name;
		      	  this.data_v.BUILD_ID = item.id;
		      	  this.goBack();
		      	},
		      	//显示历史记录
		      	handleShowArea: function(){
		      	  displayHistory();
		      	  document.getElementById('search').focus();
		      	},
		      	//清空历史记录
		      	handleClearHistory:function(){
		      	  mui.confirm('确认删除历史记录吗？',
		      	              '删除确认',
		      	              ['取消','确认'],
		      	              function(e){
		      	              	if(e.index === 1){	
		      	              	  wsCache.delete('BuildHistory');
		      	              	  displayHistory();
		      	              	}
		      	              })		      	  
		      	}
		      }
		    });
	  //获取建筑列表
	  function getListAll() {
	  	pageIndex = 0;
	  	initSearch(pageIndex, pageSize);
	  	dvAll = [];
	  	operatorType = 0;
	  	toList(operatorType);
	  }
	  function initSearch(pageIndex, pageSize){
	  	if(app.buildWhere) {
	  	  app.buildWhere.start = pageIndex * pageSize;
	  	  app.buildWhere.end = pageIndex * pageSize + pageSize;
	  	  app.buildWhere.lstOrgCode = config.ORG_CODE;
	  	}
	  }
	  function toList(Type) {
	  	var nwaiting = window.plus === undefined ? null : plus.nativeUI.showWaiting();
	  	g.ajax(config.GetBuildsPage,{
	  	  data: initSearchWhere(app),
	  	  nwaiting: nwaiting,
	  	  success: function(data){
	  	  	var dv = [];
	  	  	if(data.StatusCode === 200) {
	  	  	  for(var i = 0, len = data.Data.List.length; i < len; i++){
	  	  	  	var d = {
	  	  	  	  ID: data.Data.List[i].BUILD_ID,
	  	  	  	  TITLE:data.Data.List[i].BUILD_NAME,
	  	  	  	  ADDRESS:data.Data.List[i].ADDRESS
	  	  	  	}
	  	  	  	dv.push(d);
	  	  	  	dvAll.push(d);
	  	  	  }
	  	  	}
	  	  	app.autoSearchList = dvAll;
	  	  	if(window.plus != undefined) {
	  	  	  plus.nativeUI.closeWaiting();
	  	  	}
	  	  },
	  	  error: function(){
	  	  	if(nwaiting){
	  	  	  nwaiting.close();
	  	  	}
	  	  }
	  	})
	  }
	  function initSearchWhere(app){
	  	if(app.buildWhere) {
	  	  app.buildWhere.buildName = app.search;
	  	  return app.buildWhere;
	  	}
	  }
	  //获取搜索结果列表
      function getListByKey(key) {
	  	findData = [];
	  	if(dvAll.length > 0) {
	  	  for(var i = 0, len = dvAll.length; i < len; i++) {
	  	  	if(dvAll[i].TITLE.indexOf(key) > -1) {
	  	  	  findData.push(dvAll[i]);
	  	  	}
	  	  }
	  	}
	  	app.autoSearchList = findData;
	  }
	  //添加历史记录
	  function addHistory(key, obj) {
	  	var cookie = wsCache.get(key),
	  	    str = (cookie == null || cookie == "" ) ? "{"+ key +":[]}" : cookie,
	  	    j = new S_JSON(str);
	  	    e = "{name:'"+ obj.TITLE +"',id:'" + obj.ID + "',address:'" + obj.ADDRESS + "'}";
	  	j[key].push(e);
	  	wsCache.set(key, j.toString(), {
	  	  exp: 30 * 24 * 3600
	  	})
	  }
	  //显示历史记录
	  function displayHistory(){
	  	var _historyList = [],
	  	    key = 'BuildHistory',
	  	    json = wsCache.get(key);
	  	if(json == null || json == undefined){
	  	  app.historyList = _historyList;
	  	  return;
	  	}
	  	var j = new S_JSON(json),
	  	    m = 5;
	  	if(j[key] == null || j[key] == undefined) {
	  	  app.historyList = _historyList;
	  	  return;
	  	}
	  	for(var i = j[key].length - 1; i >= 0; i --){
	  	  if(findDataFromArr(_historyList, j[key][i].name)){
	  	  	continue;
	  	  }
	  	  _historyList.push({
	  	  	name: j[key][i].name,
	  	  	id: j[key][i].id,
	  	  	address: j[key][i].address
	  	  })
	  	  m --;
	  	  if(!m) {
	  	  	break;
	  	  }
	  	}
	  	app.historyList = _historyList;
	  }
	  //判断历史记录重复
      function findDataFromArr(arr, name) {
	  	for(var i = 0; i <  arr.length; i++) {
	  	  if(arr[i].name == name) {
	  	    return true;
	  	  }
	  	}
	  	return false;
	  }
	  </script>
	</body>
</html>
