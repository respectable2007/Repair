<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name='viewport' content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
		<title></title>
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/mui.picker.min.css"/>
		<style type="text/css">
		  aside .mui-content .mui-scroll-wrapper{
		    top: 70px;
		  }
		  .image-list {
		    width: 100%;
			height: 85px;
			background-size: cover;
			padding: 10px 10px;
			overflow: hidden;
		  }
		  .paizhao{
		  	font-size: 65px;
		  }
		  .image-item {
			width: 65px;
			height: 65px;
			background-size: 100% 100%;
			display: inline-block;
            position: relative;
			border-radius: 5px;
			margin-right: 10px;
			margin-bottom: 10px;
			border: solid 1px #e8e8e8;
			vertical-align: top;
		  }
		  .image-item .file {
			position: absolute;
			left: 0px;
			top: 0px;
			width: 100%;
			height: 100%;
			cursor: pointer;
			z-index: 0;
		  }
			.image-item.space {
				border: none;
			}
			.image-item .image-close {
				position: absolute;
				display: inline-block;
				top:-6px;
				right:-6px;
				color: #f3f3f3;
				font-weight: 200;
				z-index: 1;
			}
			.image-item .image-close i{
			  font-size: 20px;
			  background: red;
			  border-radius: 20px;
			}
		</style>
	</head>
	<body>
	  <div id="app" class="mui-off-canvas-wrap mui-slide-in">
	  	<!--菜单部分-->
	  	<aside class="mui-off-canvas-right" id='searchArea'>
	  	  <div class="mui-content">
	  	  	<div class="mui-input-row">
	  	  	  <input type="search" 
	  	  	  	     placeholder="请输入关键字"
	  	  	  	     class="mui-input-clear"
	  	  	  	     id='search'
	  	  	  	     v-model="search"
	  	  	  	     @keyup="handleSearchList($event)"/>
	  	  	  <a href="#searchArea" @tap='handleClearSearch()'>取消</a>
	  	  	</div>
	  	  	<div class="mui-scroll-wrapper">
		  	  <div class="mui-scroll">
		  	    <div v-show='search'>
		  	      <ul class="mui-table-view">
		  	      	<li v-for='item in autoSearchList'
		  	      		@tap='handleSelected(item)'
		  	      		class="mui-table-view-cell">
		              {{item.TITLE}}
		  	      	</li>
		  	      </ul>
		  	    </div>
		  	    <div v-show='!search.length'>
		  	      <!--历史记录-->
		  	      <ul class="mui-table-view">
		  	      	<li class="mui-table-view-cell mui-collapse mui-active">
		  	      	  <a href="javascript:void(0);"
		  	      	  	 class="mui-navigate-right">
		  	      	      历史记录
		  	      	  </a>
		  	      	  <div class="mui-collapse-content">
		  	      	  	<div class="mui-input-group" v-if='historyList.length'>
		  	      	  	  <div class="mui-input-row"
		  	      	  	  	   v-for='item in historyList'
		  	      	  	  	   @tap='handleHistoryDetail(item)'>
		  	      	  	  	{{item.name}}
		  	      	  	  </div>
		  	      	  	</div>
		  	      	  	<div class="mui-input-group" v-else>
		  	      	  	   <div class="mui-input-row">
		  	      	  	   	  暂无历史记录
		  	      	  	   </div>
		  	      	  	</div>
		  	      	  </div>
		  	      	  <span class="" @tap='handleClearHistory()'>
		  	      	  	<i class="mui-icon mui-icon-trash i-clear"></i>
		  	      	  </span>
		  	      	</li>
		  	      </ul>
		  	    </div>
		  	  </div>
		  	</div>
	  	  </div>
	  	</aside>
	  	<!--主页表单部分-->
	  	<div class="mui-inner-wrap">
	  	  <nav class="mui-bar mui-bar-tab">
	  	  	<button id='btnSubmit' 
	  	  		    type="button" 
	  	  		    class="mui-btn mui-btn-primary mui-btn-block"
	  	  		    @tap='handleSubmit()'>
	  	  	  提交
	  	  	</button>
	  	  </nav>
	  	  <div class="mui-content" id='mui-content'>
	  	  	<form class="mui-input-group">
	  	  	  <div v-if='repairType == 1'>
	  	  	  	<div>
	  	  	  	  <span>建筑信息</span>
	  	  	  	</div>
	  	  	  	<div>
	  	  	  	  <div>建筑名称</div>
	  	  	  	  <div v-text='data_v.BUILD_NAME'></div>
	  	  	  	</div>
	  	  	  </div>
	  	  	  <div v-else>
	  	  	  	<div class="mui-input-row mui-search readonly">
	  	  	  	  <a href="#searchArea"
	  	  	  	  	 @tap='handleShowArea()'>
	  	  	  	  	 <i class="mui-icon mui-icon-search"></i>
	  	  	  	  	 <span v-text="data_v.BUILD_NAME"></span>
	  	  	  	  </a>
	  	  	  	</div>
	  	  	  	<div class="mui-input-row">
	  	  	  	  <label>
	  	  	  	  	<i class="require">*</i>
	  	  	  	  	建筑地址
	  	  	  	  </label>
	  	  	  	  <input type="text" v-model='data_v.ADDRESS' placeholder="建筑地址" class="mui-navigate-right"/>
	  	  	  	</div>
	  	  	  </div>
	  	  	  <div class="mui-input-row">
	  	  	  	<label>
	  	  	  	  <i class="require">*</i>
	  	  	  	  故障描述
	  	  	  	</label>
	  	  	  </div>
	  	  	  <div class="mui-input-row smp-desc" style="height: 80px;">
	  	  	  	<textarea v-model="data_v.FAULT_INFO" placeholder="请输入" rows="3"></textarea>
	  	  	  </div>
	  	  	  <div class="mui-input-row" style="height: 135px;">
	  	  	  	<div id='F_SMPS' class="row image-list">
	  	  	  	  <a id='F_SMP'>
	  	  	  	  	<span class="mui-icon mui-icon-camera paizhao"></span>
	  	  	  	  </a>
	  	  	  	  <div class="image-item space"
	  	  	  	  	   v-show='imgItemList.length'
	  	  	  	  	   v-for='(item,index) in imgItemList'
	  	  	  	  	   :id='"Img"+item.name+item.divid'>
	  	  	  	  	<img id='picBig' 
	  	  	  	  		 class="file"
	  	  	  	  		 :id='index'
	  	  	  	  		 :src='item.url'/>
	  	  	  	  	<span class="del image-close"
	  	  	  	  		  @tap='handleClearImg(item, index)'>
	  	  	  	  	  <i class="mui-icon mui-icon-close" ></i>
	  	  	  	  	</span>
	  	  	  	  </div>
	  	  	  	</div>
	  	  	  </div>
	  	  	  <div class="mui-input-row"
	  	  	  	   @tap='handlePicker()'>
	  	  	  	<label>故障类型</label>
	  	  	  	<input type="text" id="faultType" 
	  	  	  		   class="mui-navigate-right" placeholder="请选择故障类型" 
	  	  	  		   readonly="readonly"
	  	  	  		   :value='faultName'/>
	  	  	  	<i class="mui-icon mui-icon-arrowright"></i>
	  	  	  </div>
	  	  	  <div class="mui-input-row"
	  	  	  	   @tap='handleDatePicker()'>
	  	  	  	<label>限定时间</label>
	  	  	  	<input type="text" id="date"
	  	  	  		   class="mui-navigate-right" placeholder="请选择时间"
	  	  	  		   readonly="readonly"
	  	  	  		   :value="limitTime" />
	  	  	  	<i class="mui-icon mui-icon-arrowright"></i>
	  	  	  </div>
	  	  	  <div class="mui-input-row">
	  	  	  	<label>是否紧急</label>
	  	  	  	<div id='isUrgency' class="mui-switch mui-switch-blue">
	  	  	  	  <div class="mui-switch-handle"></div>
	  	  	  	</div>
	  	  	  </div>
	  	  	</form>
	  	  </div>
	  	</div>
	  </div>
	  <script src="../../js/mui.min.js" type  ="text/javascript"></script>
	  <script src="../../js/libs/vue.min.js" type  ="text/javascript"></script>
	  <script src="../../js/libs/mui.picker.min.js" type  ="text/javascript"></script>
	  <!--<script src="../../js/libs/mui.zoom.js" type  ="text/javascript"></script>
	  <script src="../../js/libs/mui.previewimage.js" type  ="text/javascript"></script>-->
	  <script src="../../js/common/config.js" type  ="text/javascript"></script>
	  <script src="../../js/libs/mock-min.js" type  ="text/javascript"></script>
	  <script src="../../js/common/global.js" type  ="text/javascript"></script>
	  <script src="../../js/common/webSql.js" type  ="text/javascript"></script>
	  <script src="../../js/common/mockdata.js" type  ="text/javascript"></script>
	  <script src="../../js/common/web-storage-cache.js" type  ="text/javascript"></script>
	  <script src="../../js/common/json.js" type  ="text/javascript"></script>
	  <script type="text/javascript">
	  	mui.init();
//	  	mui.previewImage();
        var defaultTxt = "搜索建筑名称（必填）",
            //分页
            pageSize = 1000,
            pageIndex = 0,
            start = 0,
            end = pageSize,
            dvAll = [],
            findData = [],//查找后集合
            operatorType = 0,//操作类型：1：代表下拉刷新，2：上拉加载
            wsCache = new WebStorageCache(),//本地存储
            sltImgCount = 0,//当前选中的图片数
            showDetailFun = undefined,//选择图片后回调函数
      	    callBackFun = undefined,//显示图片后回调函数
      	    localImgUrl = '',//压缩后本地相对路径
            fullLocalImgUrl = '',//压缩后本地绝对路径
            smpImgArray = [],//压缩后图片列表
            smpCurUrl = '',//图片地址
		    app = new Vue({
		      el: '#app',
		      data: {
		      	repairType:0,//文字报修
		      	faultName: '',
		      	limitTime: '',
		      	data_v: {
		      	  BUILD_NAME: defaultTxt,
		      	  ADDRESS: '',
		      	  BUILD_ID: '',
		      	  FAULT_INFO: '',
		      	  FAULT_TYPE: '',
		      	  LIMIT_TIME: '',
		      	  IS_URGENCY: 0,
		      	  STATE: g.WorkOrderStatus.waitOrder.value
		      	},
		      	search: '',
		      	autoSearchList: [],
		      	historyList: [],
		      	buildWhere: {
		      	  start:0,
		      	  end:10,
		      	  lstOrgCode: config.ORG_CODE,
		      	  buildName: ''//建筑查询
		      	},
		      	imgItemList: []
		      },
		      mounted: function() {
		      	var self = this;
		      	mui.init({
	          	  beforeback: function(){
	          	  	var homeVm = plus.webview.getWebviewById('pages/home.html');
	          	  	mui.fire(homeVm, 'show');
	          	  	return true;
	          	  }
	          });
		      	mui.ready(function(){
		      	  document.getElementById('F_SMP').addEventListener('tap', function(){
		      	  	showActionSheet({
		      	  	  id: 'F_SMP',
		      	  	  multiple: true,
		      	  	  imgCount: 6,
		      	  	  showDetailFun: function(name, divid, url, path) {
		      	  	  	self.imgItemList.push({
		      	  	  	  name: name,
		      	  	  	  divid: divid,
		      	  	  	  url: url,
		      	  	  	  path: path
		      	  	  	})
		      	  	  }
		      	  	})
		      	  })
		      	  //获取列表
		      	  getListAll();
		      	  g.initScroll({
			      	id: 'mui-content',
			        h: g.getScreenInfo('width')
			      })
		      	})
		      	//图片预览
		      	mui.plusReady(function(){
		      	  mui('body').on('tap', 'img', function(e) {
		      	  	plus.nativeUI.previewImage(smpImgArray,{
		      	  	  current: e.target.id,
		      	  	  loop: true,
		      	  	  indicator:'number'
		      	  	})
		      	  })
		      	})
		      },
		      methods: {
		      	//清空关键字
		      	handleClearSearch: function() {
		      	  this.search = '';
		      	  findData = [];
		      	},
		      	//获取搜索列表
		      	handleSearchList: function(e){
		      	  this.search = e.target.value;
		      	  getListByKey(e.target.value);
		      	},
		      	//选中搜索列表
		      	handleSelected: function(item) {
		      	  addHistory('BuildHistory', item);
		      	  this.search = '';
		      	  this.data_v.ADDRESS = item.ADDRESS;
		      	  this.data_v.BUILD_NAME = item.TITLE;
		      	  this.data_v.BUILD_ID = item.ID;
		      	  this.goBack();
		      	},
		      	//返回主页面
		      	goBack: function(){
		      	  mui('#searchArea').offCanvas('close');
		      	},
		      	//选中历史列表
		      	handleHistoryDetail: function(item) {
		      	  this.data_v.ADDRESS = item.address;
		      	  this.data_v.BUILD_NAME = item.name;
		      	  this.data_v.BUILD_ID = item.id;
		      	  this.goBack();
		      	},
		      	//显示历史记录
		      	handleShowArea: function(){
		      	  displayHistory();
		      	  document.getElementById('search').focus();
		      	},
		      	//清空历史记录
		      	handleClearHistory:function(){
		      	  mui.confirm('确认删除历史记录吗？',
		      	              '删除确认',
		      	              ['取消','确认'],
		      	              function(e){
		      	              	if(e.index === 1){	
		      	              	  wsCache.delete('BuildHistory');
		      	              	  displayHistory();
		      	              	}
		      	              })		      	  
		      	},
		      	//删除照片
		      	handleClearImg: function(item, index){
		      	  this.imgItemList.splice(index, 1);
		      	  smpImgArray.splice(index, 1);
		      	},
		      	//故障类型选择
		      	handlePicker: function(){
		      	  var picker = new mui.PopPicker(),
		      	      dv = [],
		      	      self = this;
		      	  g.ajax(config.GetFaultType,{
		      	    type: 'get',
		      	    success: function(data){
		      	      if(data.StatusCode === 200) {
		      	      	for(var i = 0, lens = data.Data.length; i < lens; i++) {
		      	      	  dv.push({
		      	      	  	value: data.Data[i].CODE,
		      	      	  	text: data.Data[i].NAME
		      	      	  })
		      	      	}
		      	      }
		      	      picker.setData(dv);
		      	      picker.show(function(item){
		      	      	self.faultName = item[0].text;
		      	      	self.data_v.FAULT_TYPE = item[0].value;
		      	      })
		      	    }
		      	  })
		      	},
		      	//日期选择
		      	handleDatePicker: function(){
		      	  var dtPicker = new mui.DtPicker(),
		      	      self = this;
		      	  dtPicker.show(function(item){
		      	  	self.limitTime = item.text;
		      	  	self.data_v.LIMIT_TIME = item.text;
		      	  })
		      	},
		      	//提交工单
		      	handleSubmit: function(){
		      	 if(!this.data_v.BUILD_NAME || this.data_v.BUILD_NAME == defaultTxt) {
		      	   mui.toast('建筑名称不能为空！')
//		      	   return;
		      	 }
		      	 if(!this.data_v.ADDRESS) {
		      	   mui.toast('建筑地址不能为空！')
		      	   return;
		      	 }
		      	 if(!this.data_v.FAULT_INFO) {
		      	   mui.toast('故障描述不能为空！')
		      	   return;
		      	 }
		      	  //是否紧急
	      	  	  this.data_v.IS_URGENCY = document.getElementById('isUrgency').classList.contains("mui-active")
	      	  	                         ? 1 : 0;
                  this.data_v.REPORT_TIME = g.formatDate('D', 'YMDHMS');
                  var userInfo = g.getUserInfo();
                  this.data_v.CREATE_USER_ID = userInfo.USER_ID;
                  this.data_v.REPORT_USER_NAME = userInfo.NAME;
                  this.data_v.PHONE = userInfo.PHONE;
//                document.getElementById('btnSubmit').setAttribute('disabled', true);
                  var str = '{ "StatusCode": 200, "Message": "上传成功", "Data": [';
                  if(this.imgItemList.length > 0 ) {
                  	for(var j = 0, len = this.imgItemList.length; j < len; j++){
                  	  var key = this.imgItemList[j];
                  	  str +='{"Name":"' + key +'","code:""' + key + '"}';
                  	}
                  	str += ']}';
                  } else {
                  	str += '{ "Name": "", "code": "" }] }';
                  }
                  upData(str);
		      	}
		      }
		    });
	  function upData(s) {
	  	if(s == null || s == '' || JSON.parse(s).Data.length < 1) {
	  	  return;
	  	}
	  	mui.plusReady(function(){
	  	  g.ajax(config.AddRepairBill,{
		  	data: JSON.stringify(app.data_v),
		  	success: function(data) {
              document.getElementById('btnSubmit').setAttribute('disabled', false);
              mui.back();
		  	}
		 })
	  	})
	  }
	  //获取建筑列表
	  function getListAll() {
	  	pageIndex = 0;
	  	initSearch(pageIndex, pageSize);
	  	dvAll = [];
	  	operatorType = 0;
	  	toList(operatorType);
	  }
	  function initSearch(pageIndex, pageSize){
	  	if(app.buildWhere) {
	  	  app.buildWhere.start = pageIndex * pageSize;
	  	  app.buildWhere.end = pageIndex * pageSize + pageSize;
	  	  app.buildWhere.lstOrgCode = config.ORG_CODE;
	  	}
	  }
	  function toList(Type) {
	  	var nwaiting = window.plus === undefined ? null : plus.nativeUI.showWaiting();
	  	g.ajax(config.GetBuildsPage,{
	  	  data: initSearchWhere(app),
	  	  nwaiting: nwaiting,
	  	  success: function(data){
	  	  	var dv = [];
	  	  	if(data.StatusCode === 200) {
	  	  	  for(var i = 0, len = data.Data.List.length; i < len; i++){
	  	  	  	var d = {
	  	  	  	  ID: data.Data.List[i].BUILD_ID,
	  	  	  	  TITLE:data.Data.List[i].BUILD_NAME,
	  	  	  	  ADDRESS:data.Data.List[i].ADDRESS
	  	  	  	}
	  	  	  	dv.push(d);
	  	  	  	dvAll.push(d);
	  	  	  }
	  	  	}
	  	  	app.autoSearchList = dvAll;
	  	  	if(window.plus != undefined) {
	  	  	  plus.nativeUI.closeWaiting();
	  	  	}
	  	  },
	  	  error: function(){
	  	  	if(nwaiting){
	  	  	  nwaiting.close();
	  	  	}
	  	  }
	  	})
	  }
	  function initSearchWhere(app){
	  	if(app.buildWhere) {
	  	  app.buildWhere.buildName = app.search;
	  	  return app.buildWhere;
	  	}
	  }
	  //获取搜索结果列表
      function getListByKey(key) {
	  	findData = [];
	  	if(dvAll.length > 0) {
	  	  for(var i = 0, len = dvAll.length; i < len; i++) {
	  	  	if(dvAll[i].TITLE.indexOf(key) > -1) {
	  	  	  findData.push(dvAll[i]);
	  	  	}
	  	  }
	  	}
	  	app.autoSearchList = findData;
	  }
	  //添加历史记录
	  function addHistory(key, obj) {
	  	var cookie = wsCache.get(key),
	  	    str = (cookie == null || cookie == "" ) ? "{"+ key +":[]}" : cookie,
	  	    j = new S_JSON(str);
	  	    e = "{name:'"+ obj.TITLE +"',id:'" + obj.ID + "',address:'" + obj.ADDRESS + "'}";
	  	j[key].push(e);
	  	wsCache.set(key, j.toString(), {
	  	  exp: 30 * 24 * 3600
	  	})
	  }
	  //显示历史记录
	  function displayHistory(){
	  	var _historyList = [],
	  	    key = 'BuildHistory',
	  	    json = wsCache.get(key);
	  	if(json == null || json == undefined){
	  	  app.historyList = _historyList;
	  	  return;
	  	}
	  	var j = new S_JSON(json),
	  	    m = 5;
	  	if(j[key] == null || j[key] == undefined) {
	  	  app.historyList = _historyList;
	  	  return;
	  	}
	  	for(var i = j[key].length - 1; i >= 0; i --){
	  	  if(findDataFromArr(_historyList, j[key][i].name)){
	  	  	continue;
	  	  }
	  	  _historyList.push({
	  	  	name: j[key][i].name,
	  	  	id: j[key][i].id,
	  	  	address: j[key][i].address
	  	  })
	  	  m --;
	  	  if(!m) {
	  	  	break;
	  	  }
	  	}
	  	app.historyList = _historyList;
	  }
	  //判断历史记录重复
      function findDataFromArr(arr, name) {
	  	for(var i = 0; i <  arr.length; i++) {
	  	  if(arr[i].name == name) {
	  	    return true;
	  	  }
	  	}
	  	return false;
	  }
      //相册选择或拍照
      function showActionSheet(item) {
      	var divid = item.id,
      	   imgCount = item.imgCount || 5,
      	   showDetailFun = item.showDetailFun,
      	   callBackFun = item.callBackFun || undefined;
      	if(item.type == 'paizhao') {
      	  getImage(divid,item);
      	} else {
      	  var actionSheet = {
      	  	title: '选取照片',
      	  	cancel: '取消',
      	  	buttons: [{
      	  	  title: '拍照'
      	  	},{
      	  	  title: '相册选取'
      	  	}]
      	  }
      	  plus.nativeUI.actionSheet(actionSheet, function(e){
      	  	if(e.index === 1) {
      	  	  getImage(divid, item);
      	  	} else if(e.index === 2) {
      	  	  galleryImage(divid, item);
      	  	}
      	  })
      	}
      }
      
      /**
       * 显示压缩图片
       * @param {string} target 压缩转换后的图片路径
       * @param {string} divid  字段名称
       * @param {string} name  图片名称
       * @param {string} path  压缩转换后图片的本地路径
       */
      function showImageDetail(name,divid,url,path) {
      	app.imgItemList.push({
      	  name: name,
      	  divid: divid,
      	  url: url,
      	  path: path
      	})
      }
      /**
       * 保存压缩图片
       * @param {string} target 压缩转换后的图片路径
       * @param {string} divid  字段名称
       * @param {string} name  图片名称
       * @param {string} path  压缩转换后图片的本地路径
       */
      function saveImage(target, divid, name, path) {
      	plus.nativeUI.showWaiting();
      	smpImgArray.push(path);
      	if(showDetailFun == undefined) {
      	  showImageDetail(name, divid, target, path);
      	} else {
      	  smpCurUrl = target;
      	  showDetailFun(name, divid, target, path);
      	}
      	plus.nativeUI.closeWaiting();
      }
      //压缩图片
      function compressImage(url, name, divid){
      	var path = '_doc/upload/' + divid + "-" + g.getCurrentTimeFormat() + name;//压缩图片保存相对路径，以_doc为开头
      	plus.zip.compressImage({
      	  src: url,//压缩转换图片原始路径，file:
      	  dst: path,//压缩转换图片保存的相对路径，_doc/
      	  quality: 20,//压缩图片质量
      	  overwrite: true//是否覆盖新生成的文件
      	}, function(e){
      	  //压缩完成后，检测图片是否成功
      	  plus.io.resolveLocalFileSystemURL(path, function(entry){
      	  	var compress_path = entry.toLocalURL();
      	  	fullLocalImgUrl = compress_path;//压缩转换图片的本地路径
      	  	localImgUrl = path;//相对路径
      	  	//e.target-压缩转换后的图片url路径，以"file://"开头
      	  	saveImage(e.target,divid,name,compress_path);
      	  },function(e){
      	  	plus.nativeUI.toast('本地保存失败：' + e.message);
      	  })
      	}, function(e){
      	  plus.nativeUI.toast('压缩图片失败，请稍后再试');
      	})
      }
      //本地系统选择图片
      /**
       * @param {string} divid 字段名称
       * @param {object} conf  图片对象
       */
      function galleryImage(divid, conf) {
      	//单选
      	if(conf.multiple == undefined || conf.multiple == false) {
      	  plus.gallery.pick(function(path){//path-选择图片或文件路径，以file:///storage为开头
      	  	//操作文件
      	  	plus.io.resolveLocalFileSystemURL(path,function(entry){//entry-请求到的目录或文件对象
      	  	  /*entry.toLocalURL()-获取目录路径转换为本地路径URL地址，以file:///storage为开头
      	  	   * entry.name-操作文件的文件名
      	  	   */
      	  	  compressImage(entry.toLocalURL(), entry.name, divid);
      	  	  sltImgCount = 1;
      	  	  if(callBackFun != undefined) {
      	  	  	callBackFun('sltImgCount', sltImgCount);
      	  	  }
      	  	}, function(e){
      	  		plus.nativeUI.toast('读取相册文件错误' + e.message);
      	  	})
      	  },function(){
      	  	console.log('取消选择图片');
      	  },{
      	  	multiple: false,
      	  	filename: '_doc/camera/'
      	  })
      	//多选
      	} else {
      	 plus.gallery.pick(function(e) {
      	   var i = 0;
      	   sltImgCount += e.files.length;
      	   if(sltImgCount > conf.imgCount) {
      	   	 mui.toast('最多只能选择' + conf.imgCount + '张图片');
      	   	 sltImgCount -= e.files.length;
      	   	 return;
      	   }
      	   setTimeout(file, 200);
      	   function file() {
      	   	 plus.io.resolveLocalFileSystemURL(e.files[i],function(entry){
      	   	 	compressImage(entry.toLocalURL(), entry.name, divid);
      	   	 },function(e){
      	   	 	plus.nativeUI.toast('读取相册文件失败'+e.message);
      	   	 })
      	   	 i++;
      	   	 if(i < e.files.length) {
      	       setTimeout(file, 200);
      	   	 }
      	   }
      	 }, function(e){
      	   plus.nativeUI.toast('选择照片失败' + e.message);
      	 },{
      	   filename: '_doc/camera/',
      	   multiple: 'true',
      	   maximum: conf.imgCount,
      	   system: false,
      	   onmaxed: function(){
      	   	mui.toast('最多只能选择' + conf.imgCount + '张图片');
      	   }
      	 })
      	}
      }
      /**
       * 调用摄像头
       * @param {string} divid 字段名称
       * @param {object} conf  操作对象
       */
      function getImage(divid, conf){
      	//获取设备默认的摄像头对象
      	var cmr = plus.camera.getCamera();
      	if(sltImgCount > conf.imgCount) {
      	  mui.toast('最多只能选择' + conf.imgCount + '张图片');
      	  return;
      	}
      	cmr.captureImage(function(path){
      	  plus.io.resolveLocalFileSystemURL(path, function(entry){
      	  	compressImage(entry.toLocalURL(), entry.name, divid);
      	  	sltImgCount += 1;
      	  	if(callBackFun != undefined) {
      	  	  callBackFun('sltImgCount', sltImgCount);
      	  	}
      	  }, function(e){
      	  	 mui.toast('读取图片失败：' + e.message);
      	  })
      	},function(){
      	  mui.toast('拍照失败');
      	},{
      	  filename: "_doc/camera/",
      	  index: 1
      	})
      }
      /**
       * 
       */
	  </script>
	</body>
</html>
